# Flexera Policy SDK - AI Agent Instructions

## Project Overview

This is the Flexera Policy SDK for developing and managing [Flexera Policies](https://docs.rightscale.com/policies/) - a governance automation system for multi-cloud environments. The repo contains:

- **fpt**: Command-line tool for policy development (`cmd/fpt/`)
- **SDK**: Auto-generated Go client for Policy API (`sdk/`)
- **Client**: High-level wrapper around SDK (`client/policy/`)
- **Auth**: OAuth and refresh token authentication (`auth/`)

## Architecture Patterns

### Generated vs. Hand-Written Code
- **SDK (`sdk/`)**: Auto-generated by Goa framework - NEVER edit directly
- **Client (`client/policy/`)**: Hand-written wrapper providing simplified interface
- **Regeneration**: Use `make sdk` to regenerate from upstream governance service

### Authentication Flow
Two distinct auth patterns based on deployment:
```go
// Legacy RightScale CM Dashboard tokens
rsAuth := auth.NewOAuthAuthenticator(host, refreshToken)

// Modern Flexera One platform tokens  
flexeraAuth := auth.NewOAuthAuthenticator(host, refreshToken)
```
Host patterns determine auth type (see `auth/refresh_token.go` regexes).

### Configuration Management
Uses Viper with dual sources:
- **File**: `~/.fpt.yml` (managed via `fpt config account`)

## Key Development Workflows

### Building and Testing
```bash
# Standard build (current platform)
make

# Cross-platform builds with versioning
make build

# Run tests with linting and coverage
make test

# Update dependencies
go mod vendor
```

### Policy Development Cycle
```bash
# 1. Syntax check
fpt check policy.pt

# 2. Upload and test run
fpt run policy.pt param1=value1 param2=value2

# 3. Debug with data retrieval
fpt retrieve_data policy.pt --names datasource1,datasource2

# 4. Local script testing
fpt script policy.pt --result output_var input1=@file.json
```

### SDK Integration Patterns

#### Client Initialization
```go
// From config file
client, err := policy.New(config.Config.Account)
```

#### Error Handling Pattern
All SDK calls return Goa service errors:
```go
if err != nil {
    if serr, ok := err.(*goa.ServiceError); ok {
        // Handle specific API errors by name
        switch serr.Name {
        case "unprocessable_entity":
            // Handle validation errors
        }
    }
}
```

## Testing Conventions

### File Structure
- Unit tests: `*_test.go` alongside source
- Test fixtures: `cmd/fpt/fixtures/` (Policy Template files)
- Integration tests: Use Ginkgo/Gomega framework

### Test Patterns
```go
// Policy template execution tests
func TestScriptMaxRunTime(t *testing.T) {
    err := runScript(ctx, templateFile, output, script, name, maxTime, params)
    // Assertions...
}
```

## Critical File Locations

### Core Commands
- `cmd/fpt/main.go`: CLI argument parsing with Kingpin
- `cmd/fpt/run.go`: Policy execution workflow (upload → apply → monitor → cleanup)
- `cmd/fpt/script.go`: Local JavaScript execution via Otto VM

### SDK Structure  
- `sdk/*/client.go`: Generated Goa clients
- `sdk/*/endpoints.go`: Generated endpoint definitions
- `sdk/http/*/client/`: Generated HTTP transport layer

### Configuration
- `config/config.go`: Viper-based config with account management
- `auth/refresh_token.go`: OAuth token refresh logic with platform detection

## Build System Details

### Version Embedding
Build process injects version info via build tags:
```go
// +build fpt_make
const VV = "fpt branch - date - commit"
```

### Cross-compilation
Makefile handles cross-platform builds with proper CGO setup for Windows (mingw).

### Release Process
- Binaries built as `.tgz` (Unix) or `.zip` (Windows)
- Version determined by Git branch/tag via `TRAVIS_BRANCH`

## Policy Template Language Integration

The `fpt script` command executes Policy Template JavaScript locally using Otto VM. Key considerations:
- 10-second default execution timeout (configurable)
- JSON parameter injection from files (`@filename.json`)
- Result extraction by variable name
- Syntax error reporting with line numbers

## Common Gotchas

1. **SDK Regeneration**: Never edit `sdk/` directly - changes will be overwritten
2. **Auth Host Patterns**: Different regex patterns determine RightScale vs. Flexera One auth
3. **Policy Cleanup**: `fpt run` automatically terminates policies unless `--keep` flag used
4. **Cross-platform Builds**: Windows builds require mingw gcc in PATH
5. **Config Precedence**: Environment variables override config file settings
